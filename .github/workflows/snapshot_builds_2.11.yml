name: Smart Data Lake Snapshot Build 2.11

on:
  push:
    branches: 
      - develop
  pull_request:
    branches: 
      - develop

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: 1.8
    - name: Cache Maven
      uses: actions/cache@v1.1.2
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-maven-
    - name: Build with Maven for Scala 2.11
      run: mvn -B -P scala-2.11 clean test --file pom.xml

    deploy:
      needs: build
      if: github.event.pull_request.merged == true

      runs-on: ubuntu-latest

      steps:
        - uses: actions/checkout@v2
        - name: Set up JDK 1.8
          uses: actions/setup-java@v1
          with:
            java-version: 1.8
        - name: Cache Maven
          uses: actions/cache@v2
          with:
            path: ~/.m2/repository
            key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
            restore-keys: ${{ runner.os }}-maven-

        - name: Maven deploy to sonatype for Scala 2.11
            uses: samuelmeuli/action-maven-publish@v1
            with:
              gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
              gpg_passphrase: ${{ secrets.GPG_PASSPHRASE }}
              nexus_username: ${{ secrets.SONATYPE_USERNAME }}
              nexus_password: ${{ secrets.SONATYPE_PASSWORD }}
              maven_profiles: scala-2.11,release-sonatype
              maven_args: -B -f pom.xml

        - name: Maven deploy to sonatype for Scala 2.12
            uses: samuelmeuli/action-maven-publish@v1
            with:
              gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
              gpg_passphrase: ${{ secrets.GPG_PASSPHRASE }}
              nexus_username: ${{ secrets.SONATYPE_USERNAME }}
              nexus_password: ${{ secrets.SONATYPE_PASSWORD }}
              maven_profiles: scala-2.12,release-sonatype
              # exclude sdl-parent as it is already uploaded with previous deploy, stays the same and cannot be replaced in remote repository
              maven_args: -B -pl '!.' -f pom.xml
